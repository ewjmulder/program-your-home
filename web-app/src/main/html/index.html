<!DOCTYPE html>
	<html>
	<head>
		<meta charset="UTF-8">
		<title>Program You Home - Web App</title>
		<link rel="stylesheet" type="text/css" href="css/jquery.mobile.custom.structure.min.css">
		<link rel="stylesheet" type="text/css" href="css/jquery.mobile.custom.theme.min.css">
		<script type="text/javascript" src="js/jquery-2.1.1.min.js"></script>
		<script type="text/javascript" src="js/jquery.mobile.custom.min.js"></script>
		<script type="text/javascript" src="js/jquery.rest.js"></script>
		<script type="text/javascript" src="js/handlebars-v3.0.1.js"></script>
		<script type="text/javascript">
			var templates = {};
			var templateNames = ["activity", "test"];
			var restClientMain;
			
			var restApiDoneFunction = function (result) {
				if (result.success) {
					refreshAll();
				} else {
					showError("REST API call returned an error: " + result.error);
				}
			};
			var restApiFailFunction = function (jqXHR, status, error) {
				showError("REST API call failed with error: " + error);
			};
			var restApiResponseFunction = function (arg1, status, arg2) {
				if (status == "success") {
					restApiDoneFunction(arg1, status, arg2);
				} else if (status == "error" || status == "parsererror") {
					restApiFailFunction(arg1, status, arg2);				
				} else {
					// TODO: all known status texts: ("success", "notmodified", "nocontent", "error", "timeout", "abort" or "parsererror")
					showError("Unknown REST API response status: ''" + status + "'.");
				}
			};
			
			$(document).ready(function () {
				// TODO: note to self: double nested requires ID for the first!
				// So my REST service starts at /main /hue etc, which makes sense indeed, sep rest services for these URL's
				// furthermore, the rest plugin really forces using the REST api, so get ready to reastify :)
				// (probably fine to support both full rest and getters along the way. (or just use rest where I can use it and
				// use simple wget style stuff to activate activities / press buttons etc)
				restClientMain = new $.RestClient("http://localhost:3737/main/");
				restClientMain.add("activities");
				restClientMain.activities.addVerb("start", "GET");
				restClientMain.activities.addVerb("stop", "GET");

				templateNames.forEach(function (templateName) {
				    $.get("/templates/" + templateName + ".hbs.html", function (contents) {
				    	templates[templateName] = Handlebars.compile(contents);
				    	//TODO: handle nicer, how to know if this is the last one?
				    	if (checkTemplateLoadingDone()) {
				    		refreshAll();
				    	}
				    });
				});
			});
			function showError(errorMessage) {
				// TODO: nicer error 'popup'.
				alert("Error occured: " + errorMessage);
			};
			function escapeHTML(s) {
				return String(s).replace(/&(?!\w+;|#\d+;|#x[\da-f]+;)/gi, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
			};
			function toggleActivity(id, currentlyActive) {
				if (currentlyActive) {
					restClientMain.activities.stop(id).always(restApiResponseFunction);					
				} else {
					restClientMain.activities.start(id).always(restApiResponseFunction);
				}
			};
			function checkTemplateLoadingDone() {
				var allDone = true;
				templateNames.forEach(function(templateName) {
					if (templates[templateName] == null) {
						allDone = false;
					}
				});
				return allDone;
			};
			function refreshAll() {
				refreshActivities();
			};
			function refreshActivities() {
				restClientMain.activities.read()
					.done(function (activities) {
				    	var activitiesHtml = templates["activity"]({ activities: activities });
			    		$("#activities").html(activitiesHtml);
					})
					.fail(restApiFailFunction);				
			};
		</script>
	</head>
	<body>
		Welcome to the <b>Program You Home - Web App</b> test page!<br />
		<br />
		<div id="activities">
			Loading activities...<br />
		</div>
		<br />
		<br />
		<div id="debug">
		</div>
	</body>
</html>