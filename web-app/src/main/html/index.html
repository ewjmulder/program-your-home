<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width initial-scale=1.0 maximum-scale=1.0 user-scalable=yes" />
		<title>Program You Home - Web App</title>
		<link rel="stylesheet" type="text/css" href="css/pyh.css" />
		<link rel="stylesheet" type="text/css" href="css/jquery.mobile.custom.structure.min.css" />
		<link rel="stylesheet" type="text/css" href="css/jquery.mobile.custom.theme.min.css" />
		<link rel="stylesheet" type="text/css" href="css/jquery.mmenu.all.css" />
		<script type="text/javascript" src="js/jquery-2.1.1.min.js"></script>
		<script type="text/javascript" src="js/jquery.mobile.custom.min.js"></script>
		<script type="text/javascript" src="js/jquery.mmenu.min.all.js"></script>
		<script type="text/javascript" src="js/jquery.rest.js"></script>
		<script type="text/javascript" src="js/handlebars-v3.0.1.js"></script>
		<!-- TODO: put functions in sep javascript file, only keep body-onload and vars in main file -->
		<script type="text/javascript">
			var templates = {};
			var templateNames = ["activities", "lights"];
			var Page = Object.freeze({
				ACTIVITIES: 1,
				LIGHTS: 2
			});
			var currentPage = Page.ACTIVITIES;
			var restClientMain;
			var restClientHue;
			
			var restApiDoneFunction = function (result) {
				if (result.success) {
					refreshCurrentPage();
				} else {
					showError("REST API call returned an error: " + result.error);
				}
			};
			var restApiFailFunction = function (jqXHR, status, error) {
				showError("REST API call failed with error: " + error);
			};
			var restApiResponseFunction = function (arg1, status, arg2) {
				if (status == "success") {
					restApiDoneFunction(arg1, status, arg2);
				} else if (status == "error" || status == "parsererror") {
					restApiFailFunction(arg1, status, arg2);				
				} else {
					// TODO: all known status texts: ("success", "notmodified", "nocontent", "error", "timeout", "abort" or "parsererror")
					showError("Unknown REST API response status: ''" + status + "'.");
				}
			};
			
			$(document).ready(function () {
				//TODO: Use iconbar extension? (http://mmenu.frebsite.nl/documentation/extensions/iconbar.html)
				$("#menu").mmenu({
					offCanvas	: true,
					extensions: ["theme-dark"],
					header		: {
						add			: true,
						update		: true,
						title		: 'Menu'
					}
				});

				//var menuApi = $("#menu").data("mmenu");
				//menuApi.open();
				
				// TODO: note to self: double nested requires ID for the first!
				// So my REST service starts at /main /hue etc, which makes sense indeed, sep rest services for these URL's
				// furthermore, the rest plugin really forces using the REST api, so get ready to reastify :)
				// (probably fine to support both full rest and getters along the way. (or just use rest where I can use it and
				// use simple wget style stuff to activate activities / press buttons etc)

				// Take the same server on port 3737 as base URL for the Program Your Home server.
				
				// Search after the 'http://' part (length 7), find the first colon or slash from there gives us our base URL.
				var indexOfColon = window.location.href.indexOf(":", 7);
				var indexOfSlash = window.location.href.indexOf("/", 7);
				var sliceIndex = indexOfColon > -1 ? indexOfColon : indexOfSlash;
				var baseURL = window.location.href.slice(0, sliceIndex) + ":3737/";
				
				restClientMain = new $.RestClient(baseURL + "main/");
				restClientMain.add("activities");
				restClientMain.activities.addVerb("start", "GET");
				restClientMain.activities.addVerb("stop", "GET");

				restClientHue = new $.RestClient(baseURL + "hue/");
				restClientHue.add("lights");
				restClientHue.lights.addVerb("on", "GET");
				restClientHue.lights.addVerb("off", "GET");

				templateNames.forEach(function (templateName) {
				    $.get("/templates/" + templateName + ".hbs.html", function (contents) {
				    	templates[templateName] = Handlebars.compile(contents);
				    	//TODO: handle nicer, how to know if this is the last one?
				    	if (checkTemplateLoadingDone()) {
				    		refreshCurrentPage();
				    		// Refresh every so often to keep in sync with server state.
				    		// TODO: unfortunately, this will flicker on my Android browser
				    		// Alternative to reload every second: have websocket connection to server
				    		// and reload only upon receiving a changed event (and ideally only if change is on current page)
				    		// Actually, the flickering is the loading of the images, so if those can be cached, it could work as well.
				    		// Not to mention, the event stuff if by far preferrable in the long run!
/*			                setInterval(function () {
					    		refreshCurrentPage();
			                }, 1000);*/
				    	}
				    });
				});
			});
			function showError(errorMessage) {
				// TODO: nicer error 'popup'. -> use mmenu or some other nice jQuery solution
				alert("Error occured: " + errorMessage);
			};
			function escapeHTML(s) {
				return String(s).replace(/&(?!\w+;|#\d+;|#x[\da-f]+;)/gi, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
			};
			function toggleActivity(id, currentlyActive) {
				if (currentlyActive) {
					restClientMain.activities.stop(id).always(restApiResponseFunction);					
				} else {
					restClientMain.activities.start(id).always(restApiResponseFunction);
				}
			};
			function toggleLight(id, currentlyOn) {
				if (currentlyOn) {
					restClientHue.lights.off(id).always(restApiResponseFunction);					
				} else {
					restClientHue.lights.on(id).always(restApiResponseFunction);
				}
			};
			function checkTemplateLoadingDone() {
				var allDone = true;
				templateNames.forEach(function(templateName) {
					if (templates[templateName] == null) {
						allDone = false;
					}
				});
				return allDone;
			};
			function loadPage(page) {
				currentPage = page;
				refreshCurrentPage();
			};
			function refreshCurrentPage() {
				if (currentPage == Page.ACTIVITIES) {
					refreshActivities();
				} else if (currentPage == Page.LIGHTS) {
					refreshLights();
				} else {
					showError("Unknown page: " + currentPage);					
				}
			};
			// TODO: generify!
			function refreshActivities() {
				restClientMain.activities.read()
					.done(function (activities) {
				    	var activitiesHtml = templates["activities"]({ activities: activities });
			    		$("#content").html(activitiesHtml);
					})
					.fail(restApiFailFunction);				
			};
			function refreshLights() {
				restClientHue.lights.read()
					.done(function (lights) {
				    	var lightsHtml = templates["lights"]({ lights: lights });
			    		$("#content").html(lightsHtml);
					})
					.fail(restApiFailFunction);				
			};
		</script>
	</head>
	<body>
		<div id="page">
			<div class="header">
				<a href="#menu"></a>
				Program Your Home
			</div>
			<div id="content" class="content">
				Please select a menu item.
			</div>
		</div>
		<!-- href='#' will have default behaviour blocked! -->
		<nav id="menu">
			<ul>
				<li><a href="#" onclick="loadPage(Page.ACTIVITIES)">Activities</a></li>
				<li><a href="#" onclick="loadPage(Page.LIGHTS)">Lights</a></li>
				<li><a href="#">Devices</a></li>
				<li><a href="#">Demo dummy</a>
					<ul>
						<li><a href="#">Sub item 1</a></li>
						<li><a href="#">Sub item 2</a>
							<ul>
								<li><a href="#">Sub sub item 1</a></li>
							</ul>
						</li>
					</ul>
				</li>
			</ul>
		</nav>
	</body>
</html>